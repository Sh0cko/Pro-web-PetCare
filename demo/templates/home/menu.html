{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Menú Principal</title>
  <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
  <style>
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 220px;
      background: #067c7c;
      color: #fff;
      padding-top: 30px;
      box-shadow: 2px 0 10px rgba(0,0,0,0.08);
      z-index: 1001;
      transform: translateX(-100%);
      transition: transform 0.3s cubic-bezier(.4,2,.6,1);
    }
    .sidebar.active {
      transform: translateX(0);
    }
    .sidebar h4 {
      text-align: center;
      margin-bottom: 2rem;
      font-weight: bold;
      color: #fff;
    }
    .sidebar .nav {
      flex-direction: column;
      gap: 10px;
    }
    .sidebar .nav-link {
      color: #fff;
      font-size: 1.08rem;
      border-radius: 8px;
      padding: 8px 18px;
      margin-bottom: 2px;
      transition: background 0.2s;
    }
    .sidebar .nav-link.active, .sidebar .nav-link:hover {
      background: #10a3a3;
      color: #fff;
    }
    .sidebar .section-title {
      margin: 18px 0 6px 18px;
      font-size: 1.05rem;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
      font-weight: bold;
      letter-spacing: 0.5px;
      display: inline-block;
    }
    .sidebar .logout-btn {
      margin-top: 40px;
      width: 90%;
      margin-left: 5%;
    }
    .sidebar-backdrop {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.18);
      z-index: 1000;
    }
    .sidebar.active ~ .sidebar-backdrop {
      display: block;
    }
    .sidebar-toggle {
      position: absolute;
      /* Coordenadas del botón que despliega el sidebar */
      top: 10px;
      left: 10px;
      z-index: 1100;
      background: #067c7c;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 4px 8px;
      font-size: 1.15rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.10);
      transition: background 1s;
    }
    .sidebar-toggle:hover {
      background: #10a3a3;
    }
    body {
      min-height: 100vh;
      background: #eaf7f7;
      padding: 24px 0;
    }
    .main-header {
      background: #06918f;
      color: #fff;
      border-radius: 16px;
      margin: 0 auto 32px auto;
      max-width: 1200px;
      padding: 18px 0 10px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      letter-spacing: 1px;
    }
    .main-content {
      max-width: 1200px;
      margin: 0 auto;
    }
    .form-card, .table-card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.10);
      padding: 2rem 2rem 1.5rem 2rem;
      margin-bottom: 32px;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      margin-bottom: 18px;
    }
    .form-group {
      flex: 1 1 220px;
      min-width: 220px;
    }
    .form-group label {
      font-weight: 600;
      margin-bottom: 6px;
      color: #06918f;
    }
    .form-control, .form-select {
      border-radius: 24px;
      border: 1.5px solid #e0e0e0;
      padding: 8px 18px;
      font-size: 1rem;
    }
    .form-control:focus, .form-select:focus {
      border-color: #10a3a3;
      box-shadow: 0 0 0 2px #10a3a322;
    }
    #especie-manual {
      border: 2px dashed #10a3a3;
      background-color: #f0fafa;
    }
    #especie-manual:focus {
      background-color: #fff;
      border: 2px solid #10a3a3;
    }
    .action-btns {
      display: flex;
      justify-content: center;
      gap: 18px;
      margin-bottom: 18px;
    }
    .action-btns .btn {
      min-width: 120px;
      font-weight: 600;
      font-size: 1.05rem;
      border-radius: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .table-card {
      padding-top: 1.2rem;
    }
    .table {
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 0;
    }
    .table thead th {
      background: #06918f;
      color: #fff;
      font-weight: 700;
      border: none;
    }
    .table tbody td {
      background: #fff;
      border: none;
      color: #333;
    }
    @media (max-width: 900px) {
      .main-content, .main-header { max-width: 98vw; padding: 0 2vw; }
      .form-row { flex-direction: column; gap: 0; }
    }
  </style>
</head>
<body>
  <button class="sidebar-toggle" id="sidebarToggle" title="Menú">
    <i class="bi bi-list"></i>
  </button>
  <div class="sidebar" id="sidebarMenu">
    <h4><i class="bi bi-paw"></i> Pet Care</h4>
    <div class="section-title">Pacientes</div>
    <nav class="nav flex-column">
      <a class="nav-link active" href="{% url 'menu' %}">Registrar</a>
      <a class="nav-link" href="{% url 'buscar_pacientes' %}">Buscar</a>
    </nav>
    <div class="section-title">Consulta</div>
    <nav class="nav flex-column">
      <a class="nav-link" href="{% url 'registrar_consulta' %}">Registrar</a>
      <a class="nav-link" href="{% url 'buscar_consultas' %}">Buscar</a>
    </nav>
    <div class="section-title">Otros</div>
    <nav class="nav flex-column">
      <a class="nav-link" href="#">Baño</a>
      <a class="nav-link" href="#">Historial</a>
      <a class="nav-link" href="#">Productos</a>
    <a class="nav-link" href="/hospedaje/">Hospedaje</a>
    </nav>
    <a href="{% url 'logout' %}" class="btn btn-danger logout-btn">Cerrar sesión</a>
  </div>
  <div class="sidebar-backdrop" id="sidebarBackdrop"></div>
  <div class="main-header">
    Registro de Mascotas - Nuevos Pacientes
  </div>
  <div class="form-card">
  <form method="post">
    {% csrf_token %}
    
    <!-- SECCIÓN: DATOS DEL PROPIETARIO -->
    <h5 class="mb-3" style="color: #06918f; border-bottom: 2px solid #06918f; padding-bottom: 8px;">
      <i class="bi bi-person"></i> Datos del Propietario
    </h5>
    
    <div class="form-row">
      <div class="form-group">
        <label>ID Propietario *</label>
        <input type="text" class="form-control" name="id_propietario" placeholder="Ej: PROP001" value="{{ mascota.propietario_id|default:'' }}" required>
      </div>
      <div class="form-group">
        <label>Nombre Propietario *</label>
        <input type="text" class="form-control" name="nombre_propietario" placeholder="Nombre completo" value="{{ mascota.nombre_propietario|default:'' }}" required>
      </div>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label>Teléfono</label>
        <input type="tel" class="form-control" name="telefono_propietario" placeholder="Ej: 123456789" value="{{ mascota.telefono_propietario|default:'' }}">
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" class="form-control" name="email_propietario" placeholder="ejemplo@email.com" value="{{ mascota.email_propietario|default:'' }}">
      </div>
    </div>
    
    <div class="form-row">
      <div class="form-group" style="flex: 2;">
        <label>Dirección</label>
        <input type="text" class="form-control" name="direccion_propietario" placeholder="Dirección completa" value="{{ mascota.direccion_propietario|default:'' }}">
      </div>
    </div>

    <!-- SECCIÓN: DATOS DE LA MASCOTA -->
    <h5 class="mb-3 mt-4" style="color: #06918f; border-bottom: 2px solid #06918f; padding-bottom: 8px;">
      <i class="bi bi-heart"></i> Datos de la Mascota
    </h5>
    
    <div class="form-row">
      <div class="form-group">
        <label>ID Mascota *</label>
        <input type="text" class="form-control" name="id_mascota" placeholder="ID de la mascota" value="{{ mascota.id|default:'' }}" required>
      </div>
      <div class="form-group">
        <label>Nombre Mascota *</label>
        <input type="text" class="form-control" name="nombre" placeholder="Nombre de la mascota" value="{{ mascota.nombre|default:'' }}" required>
      </div>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label>Especie *</label>
        <select class="form-select" id="especie-select" required onchange="toggleEspecieManual()">
          <option value="">Seleccionar especie</option>
          <option value="Perro" {% if mascota.especie == 'Perro' %}selected{% endif %}>Perro</option>
          <option value="Gato" {% if mascota.especie == 'Gato' %}selected{% endif %}>Gato</option>
          <option value="Conejo" {% if mascota.especie == 'Conejo' %}selected{% endif %}>Conejo</option>
          <option value="Hámster" {% if mascota.especie == 'Hámster' %}selected{% endif %}>Hámster</option>
          <option value="Cobaya" {% if mascota.especie == 'Cobaya' %}selected{% endif %}>Cobaya (Cuyo)</option>
          <option value="Hurón" {% if mascota.especie == 'Hurón' %}selected{% endif %}>Hurón</option>
          <option value="Ave" {% if mascota.especie == 'Ave' %}selected{% endif %}>Ave (Pájaro)</option>
          <option value="Loro" {% if mascota.especie == 'Loro' %}selected{% endif %}>Loro/Cotorra</option>
          <option value="Canario" {% if mascota.especie == 'Canario' %}selected{% endif %}>Canario</option>
          <option value="Pez" {% if mascota.especie == 'Pez' %}selected{% endif %}>Pez</option>
          <option value="Tortuga" {% if mascota.especie == 'Tortuga' %}selected{% endif %}>Tortuga</option>
          <option value="Iguana" {% if mascota.especie == 'Iguana' %}selected{% endif %}>Iguana</option>
          <option value="Serpiente" {% if mascota.especie == 'Serpiente' %}selected{% endif %}>Serpiente</option>
          <option value="Gecko" {% if mascota.especie == 'Gecko' %}selected{% endif %}>Gecko</option>
          <option value="Chinchilla" {% if mascota.especie == 'Chinchilla' %}selected{% endif %}>Chinchilla</option>
          <option value="Rata" {% if mascota.especie == 'Rata' %}selected{% endif %}>Rata</option>
          <option value="Ratón" {% if mascota.especie == 'Ratón' %}selected{% endif %}>Ratón</option>
          <option value="Erizo" {% if mascota.especie == 'Erizo' %}selected{% endif %}>Erizo</option>
          <option value="Caballo" {% if mascota.especie == 'Caballo' %}selected{% endif %}>Caballo</option>
          <option value="Cerdo Miniatura" {% if mascota.especie == 'Cerdo Miniatura' %}selected{% endif %}>Cerdo Miniatura</option>
          <option value="__OTRA__" {% if mascota.especie == 'Otro' %}selected{% endif %}>✏️ Otra especie (escribir manualmente)</option>
        </select>
        <!-- Input hidden para enviar la especie real -->
        <input type="hidden" name="especie" id="especie-hidden" value="">
      </div>
      <div class="form-group" id="especie-manual-container" style="display: none;">
        <label>Escriba la especie *</label>
        <input type="text" class="form-control" id="especie-manual" placeholder="Ej: Tarántula, Axolote, etc.">
      </div>
      <div class="form-group">
        <label>Raza *</label>
        <select class="form-select" name="raza" id="raza-select" required>
          <option value="">Seleccionar raza</option>
          {% for raza in razas_perro %}
            <option value="{{ raza }}" {% if mascota.raza == raza %}selected{% endif %}>{{ raza }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label>Fecha de nacimiento *</label>
        <input type="date" class="form-control" name="nacimiento" value="{{ mascota.nacimiento|default:'' }}" required>
      </div>
      <div class="form-group">
        <label>Sexo *</label>
        <select class="form-select" name="sexo" required>
          <option value="">Seleccionar sexo</option>
          <option value="M" {% if mascota.sexo == 'M' %}selected{% endif %}>Macho</option>
          <option value="H" {% if mascota.sexo == 'H' %}selected{% endif %}>Hembra</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Color</label>
        <input type="text" class="form-control" name="color" placeholder="Color de la mascota" value="{{ mascota.color|default:'' }}">
      </div>
    </div>

    <div class="action-btns">
      <button type="submit" class="btn btn-success"><i class="bi bi-plus-circle"></i> Crear</button>
      <button type="reset" class="btn btn-secondary"><i class="bi bi-eraser"></i> Limpiar</button>
      <button type="button" class="btn btn-danger"><i class="bi bi-trash"></i> Eliminar</button>
      <button type="button" class="btn btn-info" style="color:white;"><i class="bi bi-arrow-left"></i> Regresar</button>
      <button type="button" class="btn btn-warning"><i class="bi bi-pencil-square"></i> Actualizar</button>
    </div>
  </form>
</div>
        <div class="table-card">
      <h5 class="mb-3" style="color: #06918f;">
        <i class="bi bi-list"></i> Mascotas Registradas
      </h5>
      <table class="table table-bordered table-hover">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Especie</th>
            <th>Raza</th>
            <th>Nacimiento</th>
            <th>Sexo</th>
            <th>Propietario</th>
            <th>Teléfono</th>
          </tr>
        </thead>
        <tbody>
          {% for mascota in mascotas %}
          <tr>
            <td>{{ mascota.id }}</td>
            <td>{{ mascota.nombre }}</td>
            <td>{{ mascota.especie }}</td>
            <td>{{ mascota.raza }}</td>
            <td>{{ mascota.nacimiento }}</td>
            <td>
              {% if mascota.sexo == 'M' %}
                <span class="badge bg-primary">Macho</span>
              {% else %}
                <span class="badge bg-pink" style="background-color: #e83e8c;">Hembra</span>
              {% endif %}
            </td>
            <td>{{ mascota.id_propietario.nombre }}</td>
            <td>{{ mascota.id_propietario.telefono|default:"-" }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center text-muted py-4">
              <i class="bi bi-inbox" style="font-size: 2rem;"></i><br>
              No hay mascotas registradas
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
  <script>
    // Sidebar toggle
    const sidebar = document.getElementById('sidebarMenu');
    const toggleBtn = document.getElementById('sidebarToggle');
    const backdrop = document.getElementById('sidebarBackdrop');
    toggleBtn.addEventListener('click', () => {
      sidebar.classList.toggle('active');
      backdrop.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
    });
    backdrop.addEventListener('click', () => {
      sidebar.classList.remove('active');
      backdrop.style.display = 'none';
    });

    // Función para mostrar/ocultar campo de especie manual
    function toggleEspecieManual() {
      const especieSelect = document.getElementById('especie-select');
      const especieManualContainer = document.getElementById('especie-manual-container');
      const especieManualInput = document.getElementById('especie-manual');
      const especieHidden = document.getElementById('especie-hidden');
      
      console.log('toggleEspecieManual - Especie seleccionada:', especieSelect.value);
      
      if (especieSelect.value === '__OTRA__') {
        especieManualContainer.style.display = 'block';
        especieManualInput.required = true;
        especieHidden.value = ''; // Limpiar hasta que se escriba algo
      } else {
        especieManualContainer.style.display = 'none';
        especieManualInput.required = false;
        especieManualInput.value = '';
        // IMPORTANTE: Actualizar el campo hidden con el valor real del select
        especieHidden.value = especieSelect.value;
        console.log('Campo hidden actualizado a:', especieHidden.value);
      }
      
      // Actualizar razas según especie
      actualizarRazas();
    }

    // Razas por especie
    const razasPorEspecie = {
      'Perro': ["Chihuahua", "Pug", "Pastor Alemán", "Labrador", "Golden Retriever", "Bulldog", "Beagle", "Dálmata", "Boxer", "Shih Tzu", "Pomerania", "Pitbull", "Schnauzer", "Doberman", "Rottweiler", "Cocker Spaniel", "Border Collie", "Husky", "Samoyedo", "Akita", "Sin especificar"],
      'Gato': ["Siamés", "Persa", "Maine Coon", "Bengala", "Sphynx", "Ragdoll", "British Shorthair", "Abisinio", "Escocés", "Noruego", "Sin especificar"],
      'Conejo': ['Belier', 'Holandés Enano', 'Cabeza de León', 'Rex', 'Angora', 'Gigante de Flandes', 'Mini Lop', 'Sin especificar'],
      'Hámster': ['Sirio', 'Ruso', 'Roborovski', 'Chino', 'Campbell', 'Sin especificar'],
      'Cobaya': ['Abisinia', 'Americana', 'Peruana', 'Skinny', 'Teddy', 'Rex', 'Sin especificar'],
      'Hurón': ['Sable', 'Albino', 'Plateado', 'Chocolate', 'Champagne', 'Sin especificar'],
      'Ave': ['Canario', 'Periquito', 'Diamante Mandarín', 'Agapornis', 'Cacatúa', 'Loro', 'Guacamayo', 'Ninfa', 'Sin especificar'],
      'Loro': ['Guacamayo', 'Amazonas', 'Cacatúa', 'Yaco', 'Eclectus', 'Agapornis', 'Sin especificar'],
      'Canario': ['Canario Común', 'Roller', 'Timbrado', 'Gloster', 'Yorkshire', 'Sin especificar'],
      'Pez': ['Goldfish', 'Betta', 'Guppy', 'Tetra', 'Pez Ángel', 'Molly', 'Platy', 'Cíclido', 'Sin especificar'],
      'Tortuga': ['Rusa', 'Mora', 'De orejas rojas', 'De orejas amarillas', 'Sulcata', 'Mapa', 'Sin especificar'],
      'Iguana': ['Iguana Verde', 'Iguana del Desierto', 'Iguana Rinoceronte', 'Sin especificar'],
      'Serpiente': ['Boa Constrictora', 'Pitón Bola', 'Serpiente del Maíz', 'Pitón Real', 'Sin especificar'],
      'Gecko': ['Gecko Leopardo', 'Gecko Crestado', 'Gecko Diurno', 'Sin especificar'],
      'Chinchilla': ['Estándar', 'Blanca', 'Ébano', 'Beige', 'Violeta', 'Sin especificar'],
      'Rata': ['Dumbo', 'Estándar', 'Rex', 'Sin cola', 'Sin especificar'],
      'Ratón': ['Común', 'Satinado', 'Angora', 'Sin especificar'],
      'Erizo': ['Africano Pigmeo', 'Europeo', 'Sin especificar'],
      'Caballo': ['Pura Sangre', 'Árabe', 'Cuarto de Milla', 'Andaluz', 'Frisón', 'Appaloosa', 'Mustang', 'Sin especificar'],
      'Cerdo Miniatura': ['Mini Pig', 'Vietnamita', 'Juliana', 'Sin especificar'],
      '__OTRA__': ['Sin especificar']
    };

    function actualizarRazas() {
      const especieSelect = document.getElementById('especie-select');
      const razaSelect = document.getElementById('raza-select');
      const especie = especieSelect.value;
      
      // Limpiar opciones actuales
      razaSelect.innerHTML = '<option value="">Seleccionar raza</option>';
      
      // Agregar nuevas opciones según la especie
      if (especie && razasPorEspecie[especie]) {
        razasPorEspecie[especie].forEach(raza => {
          const option = document.createElement('option');
          option.value = raza;
          option.textContent = raza;
          razaSelect.appendChild(option);
        });
      } else {
        // Si la especie no está en el diccionario, agregar opción genérica
        const option = document.createElement('option');
        option.value = 'Sin especificar';
        option.textContent = 'Sin especificar';
        razaSelect.appendChild(option);
      }
    }

    // Inicializar al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
      toggleEspecieManual();
      actualizarRazas();
    });

    // Actualizar cuando cambie el campo manual
    document.getElementById('especie-manual').addEventListener('input', function() {
      const especieHidden = document.getElementById('especie-hidden');
      especieHidden.value = this.value.trim();
    });

    // Actualizar razas cuando cambie la especie
    document.getElementById('especie-select').addEventListener('change', function() {
      toggleEspecieManual();
      actualizarRazas();
    });

    // Interceptar el envío del formulario
    document.querySelector('form').addEventListener('submit', function(e) {
      const especieSelect = document.getElementById('especie-select');
      const especieManualInput = document.getElementById('especie-manual');
      const especieHidden = document.getElementById('especie-hidden');
      const razaSelect = document.getElementById('raza-select');
      
      console.log('=== ENVÍO DEL FORMULARIO ===');
      console.log('Especie select:', especieSelect.value);
      console.log('Especie manual:', especieManualInput.value);
      console.log('Raza seleccionada:', razaSelect.value);
      
      // Validar y actualizar especie
      if (especieSelect.value === '__OTRA__') {
        if (!especieManualInput.value.trim()) {
          e.preventDefault();
          alert('Por favor, especifica la especie en el campo de texto.');
          return false;
        }
        especieHidden.value = especieManualInput.value.trim();
      } else if (especieSelect.value === '') {
        e.preventDefault();
        alert('Por favor, selecciona una especie.');
        return false;
      } else {
        especieHidden.value = especieSelect.value;
      }
      
      console.log('Especie final (hidden):', especieHidden.value);
      
      // Asegurar que hay una raza seleccionada
      if (!razaSelect.value) {
        e.preventDefault();
        alert('Por favor, selecciona una raza.');
        return false;
      }
      
      console.log('Formulario válido, enviando...');
      return true;
    });
  </script>
</body>
</html>
